"""
AEGIS CYBERNET - Pentagon Neural Platform + Kali Linux Integration
Complete cybersecurity platform with penetration testing tools

Installation:
pip install flask

Run:
python aegis_cybernet.py

Then open: http://localhost:5000
"""

from flask import Flask, render_template_string, jsonify, request
import hashlib
import secrets
import json
import os
import sqlite3
from datetime import datetime
from collections import deque
import re
import random
import subprocess
import platform
import socket

app = Flask(__name__)

# Create data directory
os.makedirs('aegis_data', exist_ok=True)
os.makedirs('aegis_data/logs', exist_ok=True)
os.makedirs('aegis_data/reports', exist_ok=True)
os.makedirs('aegis_data/scans', exist_ok=True)

class AEGISDatabase:
    """SQLite database manager"""
    
    def __init__(self, db_path='aegis.db'):
        self.db_path = db_path
        self.init_database()
    
    def init_database(self):
        """Initialize database tables"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS threat_analysis (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                analysis_id TEXT UNIQUE,
                timestamp TEXT,
                data_analyzed TEXT,
                threat_level REAL,
                priority INTEGER,
                confidence REAL,
                actions TEXT,
                classification TEXT
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS kali_scans (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                scan_id TEXT UNIQUE,
                timestamp TEXT,
                tool TEXT,
                target TEXT,
                command TEXT,
                output TEXT,
                status TEXT
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS crypto_operations (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                timestamp TEXT,
                operation_type TEXT,
                algorithm TEXT,
                input_data TEXT,
                output_hash TEXT,
                status TEXT
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS terminal_logs (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                timestamp TEXT,
                message TEXT,
                log_type TEXT
            )
        ''')
        
        conn.commit()
        conn.close()
    
    def save_analysis(self, analysis_data):
        """Save threat analysis"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO threat_analysis 
            (analysis_id, timestamp, data_analyzed, threat_level, priority, confidence, actions, classification)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            analysis_data['analysis_id'],
            analysis_data['timestamp'],
            analysis_data.get('data_analyzed', ''),
            analysis_data['threat_level'],
            analysis_data['priority'],
            analysis_data['confidence'],
            json.dumps(analysis_data['actions']),
            analysis_data['classification']
        ))
        
        conn.commit()
        conn.close()
    
    def save_kali_scan(self, scan_data):
        """Save Kali scan results"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO kali_scans 
            (scan_id, timestamp, tool, target, command, output, status)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        ''', (
            scan_data['scan_id'],
            scan_data['timestamp'],
            scan_data['tool'],
            scan_data['target'],
            scan_data['command'],
            scan_data['output'],
            scan_data['status']
        ))
        
        conn.commit()
        conn.close()
    
    def save_log(self, message, log_type):
        """Save terminal log"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO terminal_logs (timestamp, message, log_type)
            VALUES (?, ?, ?)
        ''', (datetime.now().isoformat(), message, log_type))
        
        conn.commit()
        conn.close()
    
    def get_recent_scans(self, limit=10):
        """Get recent Kali scans"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT scan_id, timestamp, tool, target, status, output
            FROM kali_scans
            ORDER BY timestamp DESC
            LIMIT ?
        ''', (limit,))
        
        results = cursor.fetchall()
        conn.close()
        
        return [
            {
                'scan_id': row[0],
                'timestamp': row[1],
                'tool': row[2],
                'target': row[3],
                'status': row[4],
                'output': row[5][:200]
            }
            for row in results
        ]

class KaliToolsManager:
    """Manage Kali Linux penetration testing tools"""
    
    def __init__(self):
        self.tools = {
            'nmap': 'Network scanner',
            'nikto': 'Web server scanner',
            'netstat': 'Network statistics',
            'ping': 'Network connectivity test',
            'whois': 'Domain information lookup',
            'dig': 'DNS lookup',
            'traceroute': 'Network path trace',
            'netcat': 'Network utility',
            'curl': 'HTTP client',
            'wget': 'File downloader'
        }
    
    def check_tool_available(self, tool):
        """Check if tool is available on system"""
        try:
            if platform.system() == 'Windows':
                result = subprocess.run(['where', tool], capture_output=True, text=True, timeout=5)
            else:
                result = subprocess.run(['which', tool], capture_output=True, text=True, timeout=5)
            return result.returncode == 0
        except:
            return False
    
    def execute_safe_command(self, tool, target):
        """Execute safe reconnaissance commands"""
        safe_commands = {
            'nmap': f'nmap -sn {target}',
            'ping': f'ping -c 4 {target}',
            'whois': f'whois {target}',
            'dig': f'dig {target}',
            'traceroute': f'traceroute -m 15 {target}',
            'netstat': 'netstat -an',
            'curl': f'curl -I {target}',
        }
        
        if tool not in safe_commands:
            return {'error': 'Tool not supported in safe mode'}
        
        command = safe_commands[tool]
        
        try:
            # Validate target for safety
            if not self.validate_target(target):
                return {'error': 'Invalid or unsafe target'}
            
            # Execute with timeout
            result = subprocess.run(
                command.split(),
                capture_output=True,
                text=True,
                timeout=30
            )
            
            return {
                'command': command,
                'output': result.stdout + result.stderr,
                'returncode': result.returncode,
                'success': result.returncode == 0
            }
        except subprocess.TimeoutExpired:
            return {'error': 'Command timeout'}
        except Exception as e:
            return {'error': str(e)}
    
    def validate_target(self, target):
        """Validate target is safe"""
        # Remove common attack patterns
        dangerous_patterns = [';', '&&', '||', '|', '`', '$', '(', ')', '<', '>', '&']
        for pattern in dangerous_patterns:
            if pattern in target:
                return False
        
        # Basic validation
        if len(target) > 255 or len(target) < 3:
            return False
        
        return True
    
    def get_system_info(self):
        """Get system network information"""
        info = {
            'hostname': socket.gethostname(),
            'platform': platform.system(),
            'machine': platform.machine(),
            'processor': platform.processor()
        }
        
        try:
            info['ip_address'] = socket.gethostbyname(socket.gethostname())
        except:
            info['ip_address'] = 'Unknown'
        
        return info

class AEGISCyberNet:
    """Main AEGIS CyberNet system"""
    
    def __init__(self):
        self.db = AEGISDatabase()
        self.kali = KaliToolsManager()
        self.terminal_logs = deque(maxlen=50)
        self.analysis_count = 0
        self.scan_count = 0
        self.active_threats = 47
        self.confidence_score = 96.7
        
        self.add_terminal_log('[SYSTEM] AEGIS CyberNet initialized', 'success')
        self.add_terminal_log('[DATABASE] SQLite connected', 'success')
        self.add_terminal_log('[KALI] Penetration testing tools loaded', 'success')
        self.add_terminal_log('[CYBERNET] Neural network online', 'success')
    
    def add_terminal_log(self, message, log_type='info'):
        """Add terminal log"""
        timestamp = datetime.now().strftime('%H:%M:%S')
        log_entry = {'time': timestamp, 'msg': message, 'type': log_type}
        self.terminal_logs.append(log_entry)
        
        try:
            self.db.save_log(message, log_type)
        except:
            pass
    
    def neural_threat_analysis(self, data):
        """Neural threat analysis"""
        self.add_terminal_log('[NEURAL] Analyzing threat patterns...', 'warning')
        
        threat_score = 0
        data_lower = str(data).lower()
        
        # Malicious patterns
        malicious_keywords = ['exploit', 'injection', 'malware', 'backdoor', 'ransomware', 
                             'attack', 'breach', 'vulnerability', 'payload', 'shellcode',
                             'rootkit', 'trojan', 'worm', 'botnet', 'ddos']
        for keyword in malicious_keywords:
            if keyword in data_lower:
                threat_score += 0.10
        
        # SQL injection
        sql_patterns = ['drop table', 'select *', 'union select', '--', 'or 1=1', 
                       '; delete', 'exec(', 'execute(']
        for pattern in sql_patterns:
            if pattern in data_lower:
                threat_score += 0.15
        
        # XSS patterns
        xss_patterns = ['<script>', 'eval(', 'onerror=', 'javascript:', 'onload=',
                       'onclick=', 'onmouseover=', '<iframe>']
        for pattern in xss_patterns:
            if pattern in data_lower:
                threat_score += 0.18
        
        # Command injection
        cmd_patterns = ['&&', '||', ';', '`', '$()', '|', 'bash', 'sh -c']
        for pattern in cmd_patterns:
            if pattern in data_lower:
                threat_score += 0.12
        
        # Path traversal
        if '../' in data_lower or '..\\' in data_lower:
            threat_score += 0.20
        
        threat_score = min(threat_score + random.uniform(0, 0.15), 1.0)
        
        # Priority
        if threat_score > 0.8:
            priority = 5
        elif threat_score > 0.6:
            priority = 4
        elif threat_score > 0.4:
            priority = 3
        elif threat_score > 0.2:
            priority = 2
        else:
            priority = 1
        
        # Actions
        actions = []
        if threat_score > 0.7:
            actions.extend(['IMMEDIATE_ISOLATION', 'NOTIFY_SOC', 'DEPLOY_COUNTERMEASURES', 'BLOCK_IP'])
        elif threat_score > 0.5:
            actions.extend(['ESCALATE_ALERT', 'COORDINATE_RESPONSE', 'ENABLE_IDS'])
        elif threat_score > 0.3:
            actions.extend(['LOG_INCIDENT', 'INCREASE_MONITORING', 'AUDIT_LOGS'])
        else:
            actions.append('CONTINUE_MONITORING')
        
        self.analysis_count += 1
        if threat_score > 0.5:
            self.active_threats += 1
        
        self.confidence_score = 92 + random.uniform(0, 8)
        
        analysis_id = f'ANA-{secrets.token_hex(4).upper()}'
        result = {
            'analysis_id': analysis_id,
            'threat_level': round(threat_score, 3),
            'priority': priority,
            'confidence': round(self.confidence_score, 1),
            'actions': actions,
            'classification': 'TOP_SECRET//NOFORN',
            'timestamp': datetime.now().isoformat(),
            'data_analyzed': data[:200]
        }
        
        try:
            self.db.save_analysis(result)
            self.add_terminal_log(f'[DATABASE] Analysis {analysis_id} saved', 'success')
        except Exception as e:
            self.add_terminal_log(f'[ERROR] {str(e)}', 'error')
        
        self.add_terminal_log(f'[COMPLETE] Threat: {threat_score:.3f} | Priority: {priority}', 'success')
        
        return result
    
    def execute_kali_tool(self, tool, target):
        """Execute Kali tool"""
        self.add_terminal_log(f'[KALI] Executing {tool} on {target}...', 'warning')
        
        # Check if tool is available
        if not self.kali.check_tool_available(tool):
            self.add_terminal_log(f'[ERROR] Tool {tool} not found on system', 'error')
            return {
                'error': f'Tool {tool} not available. Install Kali Linux tools or run on compatible system.',
                'status': 'FAILED'
            }
        
        # Execute command
        result = self.kali.execute_safe_command(tool, target)
        
        scan_id = f'SCAN-{secrets.token_hex(4).upper()}'
        self.scan_count += 1
        
        scan_data = {
            'scan_id': scan_id,
            'timestamp': datetime.now().isoformat(),
            'tool': tool,
            'target': target,
            'command': result.get('command', ''),
            'output': result.get('output', result.get('error', 'No output'))[:5000],
            'status': 'SUCCESS' if result.get('success') else 'FAILED'
        }
        
        try:
            self.db.save_kali_scan(scan_data)
            self.add_terminal_log(f'[DATABASE] Scan {scan_id} saved', 'success')
        except Exception as e:
            self.add_terminal_log(f'[ERROR] {str(e)}', 'error')
        
        if result.get('success'):
            self.add_terminal_log(f'[COMPLETE] {tool} scan finished', 'success')
        else:
            self.add_terminal_log(f'[ERROR] {tool} scan failed', 'error')
        
        return {
            'scan_id': scan_id,
            'tool': tool,
            'target': target,
            'command': result.get('command', ''),
            'output': result.get('output', result.get('error', '')),
            'status': scan_data['status'],
            'timestamp': scan_data['timestamp']
        }
    
    def hash_data(self, data, algorithm='sha256'):
        """Generate cryptographic hash"""
        algorithms_map = {
            'sha256': hashlib.sha256,
            'sha512': hashlib.sha512,
            'md5': hashlib.md5,
            'sha1': hashlib.sha1
        }
        
        hash_func = algorithms_map.get(algorithm, hashlib.sha256)
        hash_obj = hash_func(data.encode())
        hash_value = hash_obj.hexdigest()
        
        self.add_terminal_log(f'[CRYPTO] {algorithm.upper()} hash generated', 'success')
        
        return {
            'hash': hash_value,
            'algorithm': algorithm.upper(),
            'length': len(hash_value) * 4,
            'timestamp': datetime.now().isoformat()
        }

# Initialize system
aegis = AEGISCyberNet()

HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AEGIS CyberNet - Pentagon Platform</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {background: linear-gradient(135deg, #0a0a1a 0%, #000 100%);}
.gradient-text {
  background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ef4444 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.pulse {animation: pulse 2s ease-in-out infinite;}
@keyframes pulse {0%, 100% {opacity: 1;} 50% {opacity: .5;}}
.glow {box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);}
.scan-line {
  position: relative;
  overflow: hidden;
}
.scan-line::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, transparent, #00ff00, transparent);
  animation: scan 2s linear infinite;
}
@keyframes scan {
  0% {left: -100%;}
  100% {left: 100%;}
}
</style>
</head>
<body class="text-white font-mono min-h-screen">

<div class="bg-black/90 border-b border-slate-800 sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 py-3">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-to-r from-red-500 via-orange-500 to-yellow-500 rounded-xl flex items-center justify-center">
          <span class="text-xl">‚öîÔ∏è</span>
        </div>
        <div>
          <h1 class="text-xl font-black gradient-text">AEGIS CYBERNET</h1>
          <p class="text-xs text-slate-400">Pentagon Platform + Kali Linux Integration</p>
        </div>
      </div>
      <div class="flex items-center space-x-4 text-sm">
        <div class="text-red-400 font-bold">üî¥ LIVE</div>
        <div id="confidence" class="text-emerald-400 font-bold">96.7%</div>
      </div>
    </div>
  </div>
</div>

<div class="max-w-7xl mx-auto px-4 py-6">
  <!-- Status Bar -->
  <div class="bg-slate-900/50 border border-green-500/30 rounded-xl p-4 mb-6 scan-line">
    <div class="flex items-center justify-between text-sm">
      <div class="flex items-center space-x-4">
        <span class="text-green-400">‚óè CYBERNET ACTIVE</span>
        <span class="text-green-400">‚óè KALI TOOLS READY</span>
        <span class="text-green-400">‚óè DATABASE ONLINE</span>
      </div>
      <div id="system-info" class="text-slate-400">Loading system info...</div>
    </div>
  </div>

  <!-- Metrics -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-slate-900/50 border border-red-500/30 rounded-xl p-5 glow">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-bold text-sm">üö® THREATS</h3>
        <span class="text-xs bg-red-500/20 px-2 py-1 rounded">ACTIVE</span>
      </div>
      <div id="threats" class="text-3xl font-black text-red-400 pulse">47</div>
    </div>
    
    <div class="bg-slate-900/50 border border-blue-500/30 rounded-xl p-5">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-bold text-sm">üî¨ ANALYSES</h3>
        <span class="text-xs bg-blue-500/20 px-2 py-1 rounded">TOTAL</span>
      </div>
      <div id="analyses" class="text-3xl font-black text-blue-400">0</div>
    </div>
    
    <div class="bg-slate-900/50 border border-emerald-500/30 rounded-xl p-5">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-bold text-sm">‚úÖ CONFIDENCE</h3>
        <span class="text-xs bg-emerald-500/20 px-2 py-1 rounded">NEURAL</span>
      </div>
      <div id="conf-main" class="text-3xl font-black text-emerald-400">96.7%</div>
    </div>
    
    <div class="bg-slate-900/50 border border-orange-500/30 rounded-xl p-5">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-bold text-sm">‚öîÔ∏è SCANS</h3>
        <span class="text-xs bg-orange-500/20 px-2 py-1 rounded">KALI</span>
      </div>
      <div id="scans" class="text-3xl font-black text-orange-400">0</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="flex space-x-2 mb-6 overflow-x-auto">
    <button onclick="setTab('neural')" id="btn-neural" class="px-6 py-3 rounded-lg bg-purple-500/20 border-2 border-purple-400 font-bold whitespace-nowrap">
      üß† Neural Analysis
    </button>
    <button onclick="setTab('kali')" id="btn-kali" class="px-6 py-3 rounded-lg hover:bg-slate-800/50 border-2 border-transparent font-bold whitespace-nowrap">
      ‚öîÔ∏è Kali Tools
    </button>
    <button onclick="setTab('crypto')" id="btn-crypto" class="px-6 py-3 rounded-lg hover:bg-slate-800/50 border-2 border-transparent font-bold whitespace-nowrap">
      üîê Cryptography
    </button>
    <button onclick="setTab('history')" id="btn-history" class="px-6 py-3 rounded-lg hover:bg-slate-800/50 border-2 border-transparent font-bold whitespace-nowrap">
      üìä Scan History
    </button>
  </div>

  <!-- Neural Tab -->
  <div id="tab-neural" class="tab-content">
    <div class="bg-gradient-to-br from-purple-900/30 to-black/50 border-2 border-purple-600/50 rounded-2xl p-6">
      <h2 class="text-2xl font-black mb-4 gradient-text">üß† Neural Threat Analysis</h2>
      
      <div class="mb-4">
        <label class="block font-bold mb-2 text-slate-300">Data Input</label>
        <textarea id="neural-input" class="w-full h-32 bg-slate-900/80 border-2 border-slate-700 rounded-xl px-4 py-3 text-white font-mono text-sm focus:border-purple-400 focus:outline-none resize-none" placeholder="Enter data for analysis...">admin' OR '1'='1' --; DROP TABLE users; <script>alert('xss')</script> && rm -rf /</textarea>
      </div>
      
      <button onclick="runAnalysis()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 font-bold py-4 px-6 rounded-xl shadow-lg text-lg">
        üß† ANALYZE THREAT PATTERNS
      </button>
      
      <div id="results" class="hidden mt-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-red-500/20 border-2 border-red-500/50 rounded-xl p-5">
            <h3 class="font-bold mb-2 text-sm">üî• THREAT LEVEL</h3>
            <div id="threat-level" class="text-3xl font-black text-red-400">0%</div>
          </div>
          <div class="bg-orange-500/20 border-2 border-orange-500/50 rounded-xl p-5">
            <h3 class="font-bold mb-2 text-sm">‚ö° PRIORITY</h3>
            <div id="priority" class="text-3xl font-black text-orange-400">0</div>
          </div>
          <div class="bg-emerald-500/20 border-2 border-emerald-500/50 rounded-xl p-5">
            <h3 class="font-bold mb-2 text-sm">‚úÖ CONFIDENCE</h3>
            <div id="neural-conf" class="text-3xl font-black text-emerald-400">0%</div>
          </div>
        </div>
        
        <div class="bg-slate-900/80 border-2 border-slate-700 rounded-xl p-5">
          <h3 class="font-bold mb-3">üìã Recommended Actions</h3>
          <div id="actions" class="space-y-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Kali Tab -->
  <div id="tab-kali" class="tab-content hidden">
    <div class="bg-gradient-to-br from-red-900/30 to-black/50 border-2 border-red-600/50 rounded-2xl p-6">
      <h2 class="text-2xl font-black mb-4 gradient-text">‚öîÔ∏è Kali Linux Penetration Testing</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block font-bold mb-2 text-slate-300">Select Tool</label>
          <select id="kali-tool" class="w-full bg-slate-900/80 border-2 border-slate-700 rounded-xl px-4 py-3 font-mono text-sm focus:border-red-400 focus:outline-none">
            <option value="nmap">nmap - Network Scanner</option>
            <option value="ping">ping - Connectivity Test</option>
            <option value="whois">whois - Domain Info</option>
            <option value="dig">dig - DNS Lookup</option>
            <option value="traceroute">traceroute - Path Trace</option>
            <option value="netstat">netstat - Network Stats</option>
            <option value="curl">curl - HTTP Client</option>
          </select>
        </div>
        
        <div>
          <label class="block font-bold mb-2 text-slate-300">Target</label>
          <input id="kali-target" class="w-full bg-slate-900/80 border-2 border-slate-700 rounded-xl px-4 py-3 font-mono text-sm focus:border-red-400 focus:outline-none" value="8.8.8.8" placeholder="IP or domain"/>
        </div>
      </div>
      
      <button onclick="runKaliTool()" class="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 font-bold py-4 px-6 rounded-xl shadow-lg text-lg mb-6">
        ‚öîÔ∏è EXECUTE KALI TOOL
      </button>
      
      <div id="kali-output" class="hidden bg-black/80 border-2 border-green-500/50 rounded-xl p-5 font-mono text-xs">
        <div class="flex items-center justify-between mb-3">
          <span class="font-bold text-green-400">SCAN OUTPUT:</span>
          <span id="scan-status" class="text-xs bg-green-500/20 px-2 py-1 rounded">SUCCESS</span>
        </div>
        <div class="text-green-400 mb-2">Command: <span id="kali-command" class="text-cyan-400"></span></div>
        <pre id="kali-result" class="text-green-300 overflow-x-auto max-h-96"></pre>
      </div>
    </div>
    
    <!-- Quick Commands Reference -->
    <div class="mt-6 bg-slate-900/50 border border-slate-700 rounded-xl p-6">
      <h3 class="text-xl font-black mb-4 text-orange-400">üîß Common Kali Commands Reference</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
        <div class="bg-slate-800/50 rounded-lg p-3">
          <div class="font-bold text-cyan-400 mb-1">nmap -sn 192.168.1.0/24</div>
          <div class="text-slate-400">Ping scan entire subnet</div>
        </div>
        <div class="bg-slate-800/50 rounded-lg p-3">
          <div class="font-bold text-cyan-400 mb-1">nmap -sV -p- target</div>
          <div class="text-slate-400">Full port scan with version detection</div>
        </div>
        <div class="bg-slate-800/50 rounded-lg p-3">
          <div class="font-bold text-cyan-400 mb-1">dig @8.8.8.8 domain.com</div>
          <div class="text-slate-400">DNS query using Google DNS</div>
        </div>
        <div class="bg-slate-800/50 rounded-lg p-3">
          <div class="font-bold text-cyan-400 mb-1">whois domain.com</div>
          <div class="text-slate-400">Get domain registration info</div>
        </div>
        <div class="bg-slate-800/50 rounded-lg p-3">
          <div class="font-bold text-cyan-400 mb-1">curl -I https://target</div>
          <div class="text-slate-400">Get HTTP headers</div>
        </div>
        <div class="bg-slate-800/50 rounded-lg p-3">
          <div class="font-bold text-cyan-400 mb-1">traceroute target</div>
          <div class="text-slate-400">Trace route to target</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Crypto Tab -->
  <div id="tab-crypto" class="tab-content hidden">
    <div class="bg-gradient-to-br from-blue-900/30 to-black/50 border-2 border-blue-600/50 rounded-2xl p-6">
      <h2 class="text-2xl font-black mb-4 gradient-text">üîê Cryptography Operations</h2>
      <div class="mb-4">
        <label class="block font-bold mb-2 text-slate-300">Data to Hash</label>
        <textarea id="crypto-input" class="w-full h-32 bg-slate-900/80 border-2 border-slate-700 rounded-xl px-4 py-3 text-white font-mono text-sm focus:border-blue-400 focus:outline-none resize-none" placeholder="Enter data to hash..."></textarea>
      </div>
      <div class="mb-4">
        <label class="block font-bold mb-2 text-slate-300">Algorithm</label>
        <select id="crypto-alg" class="w-full bg-slate-900/80 border-2 border-slate-700 rounded-xl px-4 py-3 font-mono text-sm focus:border-blue-400 focus:outline-none">
          <option value="sha256">SHA-256</option>
          <option value="sha512">SHA-512</option>
          <option value="md5">MD5</option>
          <option value="sha1">SHA-1</option>
        </select>
      </div>
      <button onclick="runHash()" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 font-bold py-4 px-6 rounded-xl shadow-lg text-lg">
        üîê GENERATE HASH
      </button>
      <div id="crypto-output" class="hidden mt-6 bg-black/80 border-2 border-blue-500/50 rounded-xl p-5 font-mono text-xs">
        <div class="flex items-center justify-between mb-3">
          <span class="font-bold text-blue-400">HASH OUTPUT:</span>
          <span id="hash-alg" class="text-xs bg-blue-500/20 px-2 py-1 rounded"></span>
        </div>
        <pre id="hash-result" class="text-blue-300 overflow-x-auto max-h-96 break-all"></pre>
      </div>
    </div>
  </div>
  
  <!-- History Tab -->
  <div id="tab-history" class="tab-content hidden">
    <div class="bg-gradient-to-br from-green-900/30 to-black/50 border-2 border-green-600/50 rounded-2xl p-6">
      <h2 class="text-2xl font-black mb-4 gradient-text">üìä Scan History</h2>
      <div id="history-table" class="overflow-x-auto">
        <table class="w-full text-sm text-left text-slate-300">
          <thead class="text-xs uppercase bg-slate-800/50">
            <tr>
              <th class="px-4 py-3">ID</th>
              <th class="px-4 py-3">Time</th>
              <th class="px-4 py-3">Tool</th>
              <th class="px-4 py-3">Target</th>
              <th class="px-4 py-3">Status</th>
              <th class="px-4 py-3">Output Preview</th>
            </tr>
          </thead>
          <tbody id="history-body">
            <!-- Rows will be added here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
function setTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  document.getElementById(`tab-${tab}`).classList.remove('hidden');
  document.querySelectorAll('button[id^="btn-"]').forEach(btn => {
    btn.classList.remove('bg-purple-500/20', 'border-2', 'border-purple-400');
    btn.classList.add('hover:bg-slate-800/50', 'border-2', 'border-transparent');
  });
  const activeBtn = document.getElementById(`btn-${tab}`);
  activeBtn.classList.add('bg-purple-500/20', 'border-2', 'border-purple-400');
  activeBtn.classList.remove('hover:bg-slate-800/50', 'border-transparent');
  if (tab === 'history') {
    loadHistory();
  }
}

async function runAnalysis() {
  const input = document.getElementById('neural-input').value;
  try {
    const response = await fetch('/analyze', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({data: input})
    });
    const result = await response.json();
    document.getElementById('threat-level').textContent = (result.threat_level * 100).toFixed(1) + '%';
    document.getElementById('priority').textContent = result.priority;
    document.getElementById('neural-conf').textContent = result.confidence + '%';
    const actionsDiv = document.getElementById('actions');
    actionsDiv.innerHTML = result.actions.map(a => `<div class="bg-purple-500/20 p-2 rounded">${a}</div>`).join('');
    document.getElementById('results').classList.remove('hidden');
  } catch (e) {
    console.error(e);
  }
}

async function runKaliTool() {
  const tool = document.getElementById('kali-tool').value;
  const target = document.getElementById('kali-target').value;
  try {
    const response = await fetch('/kali', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({tool, target})
    });
    const result = await response.json();
    document.getElementById('kali-command').textContent = result.command || result.error;
    document.getElementById('kali-result').textContent = result.output;
    const statusEl = document.getElementById('scan-status');
    statusEl.textContent = result.status || 'ERROR';
    statusEl.classList.remove('bg-green-500/20', 'bg-red-500/20');
    statusEl.classList.add(result.status === 'SUCCESS' ? 'bg-green-500/20' : 'bg-red-500/20');
    document.getElementById('kali-output').classList.remove('hidden');
  } catch (e) {
    console.error(e);
  }
}

async function runHash() {
  const input = document.getElementById('crypto-input').value;
  const alg = document.getElementById('crypto-alg').value;
  try {
    const response = await fetch('/hash', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({data: input, algorithm: alg})
    });
    const result = await response.json();
    document.getElementById('hash-alg').textContent = result.algorithm;
    document.getElementById('hash-result').textContent = result.hash;
    document.getElementById('crypto-output').classList.remove('hidden');
  } catch (e) {
    console.error(e);
  }
}

async function loadHistory() {
  try {
    const response = await fetch('/history');
    const scans = await response.json();
    const body = document.getElementById('history-body');
    body.innerHTML = '';
    scans.forEach(scan => {
      const row = document.createElement('tr');
      row.classList.add('bg-slate-800/30', 'border-b', 'border-slate-700');
      row.innerHTML = `
        <td class="px-4 py-2">${scan.scan_id}</td>
        <td class="px-4 py-2">${scan.timestamp}</td>
        <td class="px-4 py-2">${scan.tool}</td>
        <td class="px-4 py-2">${scan.target}</td>
        <td class="px-4 py-2"><span class="\( {scan.status === 'SUCCESS' ? 'text-green-400' : 'text-red-400'}"> \){scan.status}</span></td>
        <td class="px-4 py-2 text-slate-400">${scan.output}</td>
      `;
      body.appendChild(row);
    });
  } catch (e) {
    console.error(e);
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  setTab('neural');
  try {
    const statusResp = await fetch('/status');
    const status = await statusResp.json();
    document.getElementById('threats').textContent = status.threats;
    document.getElementById('analyses').textContent = status.analyses;
    document.getElementById('scans').textContent = status.scans;
    document.getElementById('confidence').textContent = status.confidence.toFixed(1) + '%';
    document.getElementById('conf-main').textContent = status.confidence.toFixed(1) + '%';
    
    const sysResp = await fetch('/system');
    const sys = await sysResp.json();
    document.getElementById('system-info').textContent = `Host: ${sys.hostname} | IP: ${sys.ip_address} | OS: ${sys.platform} | Arch: ${sys.machine}`;
  } catch (e) {
    console.error(e);
  }
});
</script>
</body>
</html>
"""

@app.route('/', methods=['GET'])
def index():
    return render_template_string(HTML_TEMPLATE)

@app.route('/analyze', methods=['POST'])
def analyze():
    try:
        data = request.json.get('data', '')
        result = aegis.neural_threat_analysis(data)
        return jsonify(result)
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/kali', methods=['POST'])
def kali():
    try:
        tool = request.json.get('tool', '')
        target = request.json.get('target', '')
        result = aegis.execute_kali_tool(tool, target)
        return jsonify(result)
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/hash', methods=['POST'])
def hash_route():
    try:
        data = request.json.get('data', '')
        algorithm = request.json.get('algorithm', 'sha256')
        result = aegis.hash_data(data, algorithm)
        return jsonify(result)
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/history', methods=['GET'])
def history():
    try:
        scans = aegis.db.get_recent_scans()
        return jsonify(scans)
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/status', methods=['GET'])
def status():
    return jsonify({
        'threats': aegis.active_threats,
        'analyses': aegis.analysis_count,
        'scans': aegis.scan_count,
        'confidence': aegis.confidence_score
    })

@app.route('/system', methods=['GET'])
def system_info():
    return jsonify(aegis.kali.get_system_info())

if __name__ == '__main__':
    app.run(debug=True)